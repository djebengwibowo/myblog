<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Loan Portfolio Simulator</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
            --success: #059669;
            --danger: #dc2626;
            --guide-bg: #fefce8;
            --guide-border: #fef08a;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; transition: all 0.3s; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Language Bar */
        .lang-bar { display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 8px; }
        .lang-select { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; }

        header { text-align: center; margin-bottom: 25px; }
        header h1 { color: var(--secondary); margin-bottom: 5px; }

        .guide-box { background: var(--guide-bg); border: 1px solid var(--guide-border); padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .guide-box h3 { margin-top: 0; color: #854d0e; display: flex; align-items: center; gap: 8px; }
        .guide-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9rem; }
        .step { background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; border: 1px solid #fef08a; }
        .step b { color: var(--secondary); display: block; margin-bottom: 4px; }

        .card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px; }
        
        .mode-selector { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .mode-btn { flex: 1; padding: 10px; border: 1px solid var(--border); background: #f9fafb; cursor: pointer; border-radius: 6px; font-weight: 600; }
        .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .form-group input:disabled { background-color: #e5e7eb; cursor: not-allowed; }

        .type-selector { background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bfdbfe; }

        .action-btn { background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
        
        .export-controls { display: flex; gap: 10px; margin-top: 20px; }
        .btn-outline { flex: 1; padding: 10px; border: 2px solid var(--primary); background: transparent; color: var(--primary); font-weight: bold; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .btn-outline:hover { background: #eff6ff; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .summary-item { background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center; }
        .summary-item h3 { margin: 0; font-size: 0.75rem; color: #6b7280; text-transform: uppercase; }
        .summary-item p { margin: 5px 0 0; font-size: 1.1rem; font-weight: bold; color: var(--secondary); }

        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; color: #4b5563; }
        .error-msg { color: var(--danger); background: #fee2e2; padding: 10px; border-radius: 6px; margin-top: 10px; display: none; text-align: center; }

        @media print { 
            .lang-bar, .guide-box, .mode-selector, .type-selector, .form-grid, .action-btn, .export-controls { display: none !important; } 
            body { background: white; padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-bar">
        <select class="lang-select" id="lang-switch" onchange="changeLanguage()">
            <option value="en">üá∫üá∏ English</option>
            <option value="id">üáÆüá© Bahasa Indonesia</option>
        </select>
    </div>

    <header>
        <h1 id="t-main-title">Professional Loan Portfolio Simulator</h1>
    </header>

    <div class="guide-box">
        <h3 id="t-guide-title">üí° Quick Start Guide</h3>
        <div class="guide-steps">
            <div id="t-step-1" class="step"><b>1. Select Goal</b>Pick what to calculate.</div>
            <div id="t-step-2" class="step"><b>2. Interest Method</b>Effective (Mortgages) or Flat (Loans).</div>
            <div id="t-step-3" class="step"><b>3. Analyze Results</b>Check summary and table.</div>
        </div>
    </div>

    <div class="card">
        <h3 id="t-calc-settings">Calculation Settings</h3>
        <div class="mode-selector">
            <button class="mode-btn active" id="btn-payment" onclick="setMode('payment')">Find Payment</button>
            <button class="mode-btn" id="btn-loan" onclick="setMode('loan')">Find Loan Amount</button>
            <button class="mode-btn" id="btn-rate" onclick="setMode('rate')">Find Rate</button>
            <button class="mode-btn" id="btn-tenor" onclick="setMode('tenor')">Find Tenor</button>
        </div>

        <div class="type-selector">
            <div class="form-group">
                <label id="t-method-label">Interest Calculation Method</label>
                <select id="interest-type">
                    <option value="effective" id="opt-effective">Effective Rate (Declining Balance)</option>
                    <option value="flat" id="opt-flat">Flat Rate (Fixed Interest)</option>
                </select>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group" id="grp-loan"><label id="l-loan">Loan Amount</label><input type="number" id="input-loan"></div>
            <div class="form-group" id="grp-payment"><label id="l-payment">Monthly Payment</label><input type="number" id="input-payment"></div>
            <div class="form-group" id="grp-rate"><label id="l-rate">Yearly Rate (%)</label><input type="number" id="input-rate" step="0.01"></div>
            <div class="form-group" id="grp-tenor"><label id="l-tenor">Tenor (Years)</label><input type="number" id="input-tenor"></div>
        </div>

        <div id="error-box" class="error-msg"></div>
        <button class="action-btn" id="t-run-btn" onclick="calculate()">Run Simulation</button>
    </div>

    <div id="result-section" class="card" style="display:none;">
        <h3 id="t-res-title">Detailed Summary</h3>
        <div class="summary-grid">
            <div class="summary-item"><h3 id="s-loan">Total Principal</h3><p id="res-loan">-</p></div>
            <div class="summary-item"><h3 id="s-payment">Monthly Payment</h3><p id="res-payment">-</p></div>
            <div class="summary-item"><h3 id="s-rate">Interest Rate</h3><p id="res-rate">-</p></div>
            <div class="summary-item"><h3 id="s-tenor">Total Tenor</h3><p id="res-tenor">-</p></div>
            <div class="summary-item"><h3 id="s-interest">Total Interest</h3><p id="res-total-interest">-</p></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr id="table-head"><th>Mo</th><th>Opening</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Closing</th></tr>
                </thead>
                <tbody id="schedule-body"></tbody>
            </table>
        </div>

        <div class="export-controls">
            <button class="btn-outline" id="t-csv-btn" onclick="exportToCSV()">üìÑ Export to Excel (CSV)</button>
            <button class="btn-outline" id="t-pdf-btn" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
        </div>
    </div>
</div>

<script>
    const translations = {
        en: {
            title: "Professional Loan Portfolio Simulator", guide: "üí° Quick Start Guide",
            s1: "<b>1. Select Goal</b>Pick what to calculate.", s2: "<b>2. Interest Method</b>Effective (Mortgages) or Flat (Loans).",
            s3: "<b>3. Analyze Results</b>Check summary and table.", settings: "Calculation Settings",
            findP: "Find Payment", findL: "Find Loan Amount", findR: "Find Rate", findT: "Find Tenor",
            method: "Interest Calculation Method", optEff: "Effective Rate (Declining Balance)", optFlat: "Flat Rate (Fixed Interest)",
            loan: "Loan Amount", payment: "Monthly Payment", rate: "Yearly Rate (%)", tenor: "Tenor (Years)",
            run: "Run Simulation", res: "Detailed Summary", totalP: "Total Principal", totalI: "Total Interest",
            totalT: "Total Tenor", yrs: "Yrs", mo: "Mo", csv: "üìÑ Export to Excel (CSV)", pdf: "üñ®Ô∏è Print / Save PDF",
            th: ["Mo", "Opening Balance", "Payment", "Principal", "Interest", "Closing Balance"]
        },
        id: {
            title: "Simulator Portofolio Pinjaman Profesional", guide: "üí° Panduan Cepat",
            s1: "<b>1. Pilih Tujuan</b>Pilih nilai yang ingin dicari.", s2: "<b>2. Metode Bunga</b>Efektif (KPR) atau Flat (Tanpa Jaminan).",
            s3: "<b>3. Analisis Hasil</b>Cek ringkasan dan tabel.", settings: "Pengaturan Perhitungan",
            findP: "Cari Cicilan", findL: "Cari Nilai Pinjaman", findR: "Cari Suku Bunga", findT: "Cari Tenor",
            method: "Metode Perhitungan Bunga", optEff: "Bunga Efektif (Saldo Menurun)", optFlat: "Bunga Flat (Tetap)",
            loan: "Jumlah Pinjaman", payment: "Cicilan Bulanan", rate: "Bunga Tahunan (%)", tenor: "Tenor (Tahun)",
            run: "Jalankan Simulasi", res: "Ringkasan Detail", totalP: "Total Pokok", totalI: "Total Bunga",
            totalT: "Total Tenor", yrs: "Thn", mo: "Bln", csv: "üìÑ Ekspor ke Excel (CSV)", pdf: "üñ®Ô∏è Cetak / Simpan PDF",
            th: ["Bln", "Saldo Awal", "Angsuran", "Pokok", "Bunga", "Saldo Akhir"]
        }
    };

    let currentMode = 'payment';
    const fmt = (n) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    const cleanNum = (str) => parseFloat(str.replace(/[^0-9.-]+/g,""));

    function changeLanguage() {
        const l = document.getElementById('lang-switch').value;
        const d = translations[l] || translations.en;
        document.getElementById('t-main-title').innerText = d.title;
        document.getElementById('t-guide-title').innerText = d.guide;
        document.getElementById('t-step-1').innerHTML = d.s1;
        document.getElementById('t-step-2').innerHTML = d.s2;
        document.getElementById('t-step-3').innerHTML = d.s3;
        document.getElementById('t-calc-settings').innerText = d.settings;
        document.getElementById('btn-payment').innerText = d.findP;
        document.getElementById('btn-loan').innerText = d.findL;
        document.getElementById('btn-rate').innerText = d.findR;
        document.getElementById('btn-tenor').innerText = d.findT;
        document.getElementById('t-method-label').innerText = d.method;
        document.getElementById('opt-effective').innerText = d.optEff;
        document.getElementById('opt-flat').innerText = d.optFlat;
        document.getElementById('l-loan').innerText = d.loan;
        document.getElementById('l-payment').innerText = d.payment;
        document.getElementById('l-rate').innerText = d.rate;
        document.getElementById('l-tenor').innerText = d.tenor;
        document.getElementById('t-run-btn').innerText = d.run;
        document.getElementById('t-res-title').innerText = d.res;
        document.getElementById('s-loan').innerText = d.totalP;
        document.getElementById('s-interest').innerText = d.totalI;
        document.getElementById('s-tenor').innerText = d.totalT;
        document.getElementById('s-payment').innerText = d.payment;
        document.getElementById('s-rate').innerText = d.rate;
        document.getElementById('t-csv-btn').innerText = d.csv;
        document.getElementById('t-pdf-btn').innerText = d.pdf;
        document.getElementById('table-head').innerHTML = d.th.map(h => `<th>${h}</th>`).join('');
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.id.includes(mode)));
        ['loan', 'payment', 'rate', 'tenor'].forEach(id => {
            document.getElementById(`input-${id}`).disabled = (id === mode);
            document.getElementById(`grp-${id}`).style.opacity = (id === mode ? '0.5' : '1');
        });
    }

    function calculate() {
        const type = document.getElementById('interest-type').value;
        const l = document.getElementById('lang-switch').value;
        const d = translations[l] || translations.en;
        let P = parseFloat(document.getElementById('input-loan').value);
        let M = parseFloat(document.getElementById('input-payment').value);
        let R = parseFloat(document.getElementById('input-rate').value) / 100;
        let T = parseFloat(document.getElementById('input-tenor').value);
        let n = T * 12, r = R / 12;

        try {
            if (type === 'flat') {
                if (currentMode === 'payment') M = (P / n) + (P * r);
                else if (currentMode === 'loan') P = M / ((1/n) + r);
                else if (currentMode === 'tenor') n = P / (M - (P * r));
                else if (currentMode === 'rate') R = ((M * n / P) - 1) / T;
            } else {
                if (currentMode === 'payment') M = P * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
                else if (currentMode === 'loan') P = M * (Math.pow(1+r, n) - 1) / (r * Math.pow(1+r, n));
                else if (currentMode === 'tenor') n = -Math.log(1 - (r*P)/M) / Math.log(1+r);
                else if (currentMode === 'rate') r = solveRate(n, M, P);
            }
            if (isNaN(M) || M <= 0) throw "Invalid inputs.";
            displayResults(P, M, (type === 'flat' ? R*100 : r*12*100), n, type, d);
        } catch (e) { 
            const err = document.getElementById('error-box');
            err.innerText = e; err.style.display = 'block'; 
        }
    }

    function solveRate(n, pmt, pv) {
        let r = 0.01;
        for(let i=0; i<30; i++) {
            let f = pmt * (1 - Math.pow(1+r, -n)) / r - pv;
            let df = pmt * (n*r*Math.pow(1+r, -n-1) - (1-Math.pow(1+r, -n))) / (r*r);
            r = r - f/df;
        } return r;
    }

    function displayResults(P, M, R, n, type, d) {
        document.getElementById('res-loan').innerText = fmt(P);
        document.getElementById('res-payment').innerText = fmt(M);
        document.getElementById('res-rate').innerText = R.toFixed(2) + '%';
        document.getElementById('res-tenor').innerHTML = `${(n/12).toFixed(1)} ${d.yrs} <span style="font-size:0.8rem;color:#6b7280;display:block;">${Math.ceil(n)} ${d.mo}</span>`;
        
        const tbody = document.getElementById('schedule-body');
        tbody.innerHTML = '';
        let balance = P, totalInt = 0, monthlyIntFixed = P * (R/100/12);

        for (let i = 1; i <= Math.ceil(n); i++) {
            let interest = (type === 'flat') ? monthlyIntFixed : balance * (R/100/12);
            let principal = M - interest;
            if (balance < principal || i === Math.ceil(n)) { principal = balance; interest = Math.max(0, M - principal); balance = 0; }
            else { balance -= principal; }
            totalInt += interest;
            tbody.innerHTML += `<tr><td>${i}</td><td>${fmt(balance+principal)}</td><td>${fmt(principal+interest)}</td><td style="color:var(--success)">${fmt(principal)}</td><td style="color:var(--danger)">${fmt(interest)}</td><td>${fmt(balance)}</td></tr>`;
            if (balance <= 0) break;
        }
        document.getElementById('res-total-interest').innerText = fmt(totalInt);
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('error-box').style.display = 'none';
    }

    function exportToCSV() {
        let csv = [];
        const rows = document.querySelectorAll("table tr");
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) {
                let text = cols[j].innerText.split('\n')[0]; // Handle the tenor span
                row.push(i === 0 ? text : cleanNum(text));
            }
            csv.push(row.join(","));
        }
        const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
        const link = document.createElement("a");
        link.download = "Loan_Simulation.csv";
        link.href = window.URL.createObjectURL(csvFile);
        link.click();
    }
</script>
</body>
</html>
